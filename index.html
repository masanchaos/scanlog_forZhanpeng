<script>
        // ==========================================
        // V9.1 修正版：防當機啟動與 Enter 修復
        // ==========================================
        
        // 1. 定義變數
        let logs = [];
        let lastActiveDate = "";
        
        // 取得 DOM 元素
        const inputField = document.getElementById('barcodeInput');
        const screenTableBody = document.querySelector('#screenTable tbody');
        const countDisplay = document.getElementById('countDisplay');
        const dateStatus = document.getElementById('dateStatus');
        const errorOverlay = document.getElementById('errorOverlay');
        const errorMsg = document.getElementById('errorMsg');
        const errorDetail = document.getElementById('errorDetail');
        const printContainer = document.getElementById('printContainer');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // 2. 安全啟動 (Try-Catch 包覆，防止因為 LocalStorage 權限導致整頁壞掉)
        try {
            logs = JSON.parse(localStorage.getItem('scanLogs')) || [];
            lastActiveDate = localStorage.getItem('lastActiveDate') || getTodayStr();
            
            // 啟動功能
            checkAutoArchive(); 
            renderScreenTable();
            
            // 設定定時檢查
            setInterval(checkAutoArchive, 60000);
            
            console.log("系統啟動成功！");
        } catch (e) {
            console.error("啟動失敗:", e);
            alert("系統啟動發生錯誤 (可能是 LocalStorage 權限問題)，請查看 Console。");
            if(dateStatus) dateStatus.textContent = "系統錯誤 (請按 F12 查看)";
        }

        // 3. 輔助函式
        function getTodayStr() {
            const now = new Date();
            return now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0');
        }

        // ==========================================
        // 核心修復：改用 keydown 監聽 Enter
        // ==========================================
        inputField.addEventListener('keydown', function (e) {
            // 只有按下 Enter (keyCode 13) 才觸發
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); // 防止某些情況下的表單送出
                
                let code = inputField.value.trim();
                console.log("偵測到 Enter，輸入內容：", code); // 用於除錯

                if (!code) return; 

                // 自動轉大寫
                code = code.toUpperCase();

                // 驗證邏輯
                const validFormat = /^[A-Z0-9]+$/;
                if (!validFormat.test(code)) {
                    triggerError("格式錯誤！", `非法符號 (僅限英數)`);
                    inputField.value = ''; return;
                }
                if (code.length > 16) {
                    triggerError("編碼過長！", `輸入 ${code.length} 碼 (上限16)`);
                    inputField.value = ''; return;
                }
                const isDuplicate = logs.some(log => log.code === code);
                if (isDuplicate) {
                    triggerError("重複掃描！", `編碼: ${code} 已存在`);
                    inputField.value = ''; return;
                }

                addLog(code);
                inputField.value = ''; 
            }
        });

        // 保持 Focus
        document.addEventListener('click', (e) => { 
            if (e.target.classList.contains('btn-del-single')) return;
            if (document.visibilityState === 'visible' && errorOverlay.style.display !== 'flex') inputField.focus(); 
        });
        
        inputField.addEventListener('blur', () => {
            if(errorOverlay.style.display !== 'flex') setTimeout(() => inputField.focus(), 100);
        });

        // ==========================================
        // 其他邏輯保持不變
        // ==========================================

        function checkAutoArchive() {
            const today = getTodayStr();
            if(dateStatus) dateStatus.textContent = `作業日期：${today}`;

            if (lastActiveDate !== today) {
                console.log("跨日偵測：執行歸檔");
                if (logs.length > 0) {
                    downloadTxt(lastActiveDate);
                    logs = [];
                    saveToStorage();
                    renderScreenTable();
                    alert(`偵測到換日！已自動備份 ${lastActiveDate} 的紀錄並清空。`);
                }
                lastActiveDate = today;
                try { localStorage.setItem('lastActiveDate', lastActiveDate); } catch(e){}
            }
        }

        function triggerError(title, detail) {
            errorMsg.textContent = title;
            errorDetail.textContent = detail || "";
            playErrorSound();
            errorOverlay.style.display = 'flex';
            inputField.blur();
        }

        function dismissError() {
            errorOverlay.style.display = 'none';
            inputField.value = ''; inputField.focus();    
        }

        document.addEventListener('keydown', function(e){
            if(e.key === 'Enter' && errorOverlay.style.display === 'flex') {
                e.preventDefault(); dismissError();
            }
        });

        function playErrorSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'square'; oscillator.frequency.value = 120; 
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
            oscillator.start();
            const now = audioCtx.currentTime;
            gainNode.gain.setValueAtTime(1, now);
            gainNode.gain.setValueAtTime(0, now + 0.1);
            gainNode.gain.setValueAtTime(1, now + 0.2);
            gainNode.gain.setValueAtTime(0, now + 0.3);
            gainNode.gain.setValueAtTime(1, now + 0.4);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
            oscillator.stop(now + 0.9);
        }

        function addLog(code) {
            const now = new Date();
            const dateStr = getTodayStr();
            const timeStr = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0') + ":" + String(now.getSeconds()).padStart(2, '0');
            logs.unshift({ date: dateStr, time: timeStr, code: code });
            saveToStorage();
            renderScreenTable();
        }

        function deleteLog(index) {
            if (confirm(`確定刪除 ${logs[index].code} ?`)) {
                logs.splice(index, 1);
                saveToStorage();
                renderScreenTable();
                inputField.focus();
            } else {
                inputField.focus();
            }
        }

        function renderScreenTable() {
            screenTableBody.innerHTML = ''; 
            logs.forEach((log, index) => {
                const row = screenTableBody.insertRow();
                row.insertCell(0).textContent = log.date;
                let timeCell = row.insertCell(1); timeCell.textContent = log.time; timeCell.className = "col-time-screen";
                let codeCell = row.insertCell(2); codeCell.textContent = log.code; codeCell.style.fontFamily = "monospace"; codeCell.style.fontWeight = "bold";
                let actionCell = row.insertCell(3);
                let delBtn = document.createElement('button');
                delBtn.textContent = '刪除'; delBtn.className = 'btn-del-single';
                delBtn.onclick = function() { deleteLog(index); };
                actionCell.appendChild(delBtn);
            });
            countDisplay.textContent = `目前筆數：${logs.length}`;
        }

        function downloadTxt(targetDate) {
            if (logs.length === 0) { if(!targetDate) alert("無資料"); return; }
            const dateToUse = targetDate || getTodayStr();
            let content = "日期\t\t時間\t\t編碼\n--------------------------------------\n";
            logs.forEach(log => { content += `${log.date}\t${log.time}\t${log.code}\n`; });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([content], { type: 'text/plain' }));
            link.download = `Log_${dateToUse}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearLogs() {
            if (confirm('確定要清空全部？')) {
                logs = []; saveToStorage(); renderScreenTable(); inputField.focus();
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('scanLogs', JSON.stringify(logs));
                localStorage.setItem('lastActiveDate', lastActiveDate); 
            } catch (e) {
                console.error("儲存失敗:", e);
                // 這裡不跳 alert 避免干擾操作，但會在 Console 報錯
            }
        }

        function printReceipt(mode) {
            if (logs.length === 0) { alert("無資料"); return; }
            printContainer.innerHTML = '';
            const now = new Date();
            const dateStr = now.getFullYear() + "/" + (now.getMonth()+1) + "/" + now.getDate();
            const totalItems = logs.length;

            if (mode === 'Thermal') {
                document.body.classList.add('thermal-mode');
                const ITEMS_PER_PAGE = 12;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                for (let i = 0; i < totalPages; i++) {
                    const pageNum = i + 1;
                    const isLastPage = (pageNum === totalPages);
                    const pageData = logs.slice(i * ITEMS_PER_PAGE, (i + 1) * ITEMS_PER_PAGE);
                    const pageDiv = document.createElement('div'); pageDiv.className = 'print-page';
                    
                    let tableHTML = `<table><thead><tr><th class="col-date">日期</th><th>貨號 / 編碼</th><th class="print-only sign-col" style="width: 50px;">簽收</th></tr></thead><tbody>`;
                    pageData.forEach(log => {
                        tableHTML += `<tr><td class="col-date">${log.date}</td><td style="font-family: monospace; font-weight: bold;">${log.code}</td><td class="sign-col"></td></tr>`;
                    });
                    tableHTML += `</tbody></table>`;
                    
                    let summaryHTML = isLastPage ? `<div class="final-summary"><div class="total-line">總計：${totalItems} 件</div><div class="signer-section">簽收人：____________________</div></div>` : '';
                    pageDiv.innerHTML = `<div class="print-header"><h1>物流簽收單</h1><div class="print-info">簽收日期：${dateStr}</div></div>${tableHTML}${summaryHTML}<div class="page-footer">第 ${pageNum} / ${totalPages} 頁</div>`;
                    printContainer.appendChild(pageDiv);
                }
                const styleId = 'thermal-page-style';
                let oldStyle = document.getElementById(styleId); if (oldStyle) oldStyle.remove();
                const css = '@page { size: 100mm 150mm; margin: 0; }';
                const style = document.createElement('style'); style.id = styleId; style.type = 'text/css'; style.appendChild(document.createTextNode(css)); document.head.appendChild(style);
            } else {
                document.body.classList.remove('thermal-mode');
                let html = `<div class="print-page"><div class="print-header" style="text-align:center; border-bottom:2px solid #000; margin-bottom:20px;"><h1>物流簽收單 (A4彙總)</h1><div class="print-info" style="text-align:right;">簽收日期：${dateStr}</div></div><table><thead><tr><th>日期</th><th>時間</th><th>貨號 / 編碼</th><th>簽收</th></tr></thead><tbody>`;
                logs.forEach(log => { html += `<tr><td>${log.date}</td><td>${log.time}</td><td style="font-family: monospace; font-weight: bold;">${log.code}</td><td></td></tr>`; });
                html += `</tbody></table><div class="signer-section" style="text-align:right; font-size:14pt; font-weight:bold; margin-top:30px; padding-top:10px; border-top:2px solid #000;">總計：${totalItems} 件 &nbsp;&nbsp;&nbsp;&nbsp; 簽收人：____________________</div></div>`;
                printContainer.innerHTML = html;
            }
            setTimeout(() => { window.print(); }, 100);
        }
    </script>
