<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµæƒæç³»çµ± (V9.2 å¼·è­¦å ±ä¿®å¾©ç‰ˆ)</title>
    <style>
        /* ================= ä¸€èˆ¬ä»‹é¢ ================= */
        body { font-family: "Microsoft JhengHei", sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; text-align: center; color: #333; transition: background-color 0.1s;}
        
        /* è¼¸å…¥æ¡† */
        #barcodeInput { 
            width: 80%; padding: 15px; font-size: 30px; text-align: center; margin-bottom: 20px; 
            border: 3px solid #333; border-radius: 5px; font-weight: bold; letter-spacing: 2px;
            text-transform: uppercase; ime-mode: disabled; 
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .controls { margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 12px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .btn-dl { background-color: #28a745; }
        .btn-print-a4 { background-color: #007bff; }
        .btn-print-thermal { background-color: #ffc107; color: #000; }
        .btn-clear { background-color: #6c757d; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-del-single { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 14px; border-radius: 3px; cursor: pointer; border: none; }

        /* è¡¨æ ¼ */
        #screenTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #screenTable th, #screenTable td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 18px; vertical-align: middle; }
        #screenTable th { background-color: #f8f9fa; }
        .col-time-screen { color: #555; font-family: monospace; }

        #printContainer { display: none; }

        /* ================= ğŸš¨ å¼·åŠ›è­¦å ±æ¨£å¼ (ä¿®å¾©èˆ‡åŠ å¼·) ================= */
        #errorOverlay {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 0, 0, 0.95); /* æ·±ç´…ä¸é€æ˜èƒŒæ™¯ */
            z-index: 99999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center;
        }
        #errorOverlay h1 { font-size: 80px; margin: 0; text-shadow: 2px 2px 10px black; }
        #errorOverlay p { font-size: 40px; margin: 10px 0; font-weight: bold; }
        #errorDetail { font-size: 30px; color: #ffeb3b; margin-top: 10px; white-space: pre-wrap; }

        /* èƒŒæ™¯é–ƒçˆå‹•ç•« (åŠ å¼·è­¦ç¤ºæ„Ÿ) */
        @keyframes bg-flash {
            0% { background-color: #fff; } 50% { background-color: #ffcccc; } 100% { background-color: #fff; }
        }
        .body-error { animation: bg-flash 0.2s infinite; }

        /* ================= ğŸ–¨ï¸ åˆ—å°å…±ç”¨æ¨£å¼ ================= */
        @media print {
            .no-print, #barcodeInput, .controls, #countDisplay, #errorOverlay, h2, #screenTable { display: none !important; }
            #printContainer { display: block !important; }
            body { margin: 0; padding: 0; background: white; color: black; animation: none; }
        }

        /* A4 æ¨¡å¼ */
        @media print {
            body:not(.thermal-mode) #printContainer { max-width: 100%; padding: 20px; }
            body:not(.thermal-mode) .print-page { page-break-after: always; }
            body:not(.thermal-mode) table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            body:not(.thermal-mode) th, body:not(.thermal-mode) td { border: 1px solid #000; padding: 5px; text-align: center; }
            body:not(.thermal-mode) .signer-section { text-align: right; margin-top: 40px; font-size: 14pt; font-weight: bold; }
        }

        /* ç†±æ•ç´™æ¨¡å¼ (100x150mm) */
        @media print {
            body.thermal-mode { width: 100mm; margin: 0; }
            body.thermal-mode .print-page {
                width: 100mm; height: 149mm; margin: 0; padding: 2mm; box-sizing: border-box; 
                overflow: hidden; position: relative; page-break-after: always; break-after: page;
                display: flex; flex-direction: column;
            }
            body.thermal-mode .print-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 5px; margin-bottom: 5px; flex-shrink: 0; }
            body.thermal-mode .print-header h1 { font-size: 16pt; margin: 0; }
            body.thermal-mode .print-info { font-size: 10pt; text-align: center; margin-top: 2px; }
            body.thermal-mode table { font-size: 11pt; width: 100%; border-collapse: collapse; }
            body.thermal-mode th, body.thermal-mode td { padding: 3px 2px; border: 1px solid #000; text-align: center; height: 7mm; }
            body.thermal-mode .col-date, body.thermal-mode .col-time { display: none; } 
            body.thermal-mode .page-footer { position: absolute; bottom: 5mm; left: 0; width: 100%; text-align: center; font-size: 9pt; }
            body.thermal-mode .final-summary { margin-top: auto; margin-bottom: 10mm; border-top: 2px dashed #000; padding-top: 5px; }
            body.thermal-mode .total-line { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 10px; }
            body.thermal-mode .signer-section { font-size: 12pt; font-weight: bold; text-align: center; border-top: 1px solid #ccc; padding-top: 10px; }
        }
    </style>
</head>
<body>

    <div id="errorOverlay" onclick="dismissError()">
        <h1>âš ï¸ è­¦å‘Š âš ï¸</h1>
        <p id="errorMsg">éŒ¯èª¤è¨Šæ¯</p>
        <div id="errorDetail"></div>
        <p style="font-size: 20px; margin-top: 30px;">(é»æ“Šç•«é¢æˆ–æŒ‰ Enter ç¹¼çºŒ)</p>
    </div>

    <h2 class="no-print">ğŸ“¦ ç‰©æµæƒæç³»çµ± (V9.2)</h2>
    <div class="no-print" style="color: #666; font-size: 14px; margin-bottom: 10px;">
        ç‹€æ…‹ï¼š<span id="dateStatus">åˆå§‹åŒ–ä¸­...</span>
    </div>
    
    <input type="text" id="barcodeInput" placeholder="è«‹æƒæ (é™è‹±æ•¸, Max 16)..." autofocus autocomplete="off">
    <div id="countDisplay" class="no-print" style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">ç›®å‰ç­†æ•¸ï¼š0</div>

    <div class="controls no-print">
        <button onclick="downloadTxt()" class="btn-dl">ğŸ“¥ æ‰‹å‹•ä¸‹è¼‰ Log</button>
        <button onclick="printReceipt('A4')" class="btn-print-a4">ğŸ“„ åˆ—å° A4</button>
        <button onclick="printReceipt('Thermal')" class="btn-print-thermal">ğŸ·ï¸ åˆ—å° 100x150</button>
        <button onclick="clearLogs()" class="btn-clear">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
    </div>

    <table id="screenTable" class="no-print">
        <thead>
            <tr>
                <th style="width: 20%">æ—¥æœŸ</th>
                <th style="width: 20%">æ™‚é–“</th>
                <th>è²¨è™Ÿ / ç·¨ç¢¼</th>
                <th style="width: 15%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="printContainer"></div>

    <script>
        let logs = [];
        let lastActiveDate = "";
        
        const inputField = document.getElementById('barcodeInput');
        const screenTableBody = document.querySelector('#screenTable tbody');
        const countDisplay = document.getElementById('countDisplay');
        const dateStatus = document.getElementById('dateStatus');
        const errorOverlay = document.getElementById('errorOverlay');
        const errorMsg = document.getElementById('errorMsg');
        const errorDetail = document.getElementById('errorDetail');
        const printContainer = document.getElementById('printContainer');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // å•Ÿå‹•ä¿è­·
        try {
            logs = JSON.parse(localStorage.getItem('scanLogs')) || [];
            lastActiveDate = localStorage.getItem('lastActiveDate') || getTodayStr();
            checkAutoArchive(); 
            renderScreenTable();
            setInterval(checkAutoArchive, 60000);
            console.log("ç³»çµ±å•Ÿå‹•æˆåŠŸ");
        } catch (e) {
            console.error("å•Ÿå‹•å¤±æ•—:", e);
            if(dateStatus) dateStatus.textContent = "ç³»çµ±éŒ¯èª¤ (LocalStorage æ¬Šé™ä¸è¶³)";
            alert("è«‹å‹™å¿…ä½¿ç”¨ GitHub Pages æˆ– Live Server é–‹å•Ÿä»¥ç¢ºä¿åŠŸèƒ½æ­£å¸¸ã€‚");
        }

        function getTodayStr() {
            const now = new Date();
            return now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0');
        }

        // ç›£è½ Enter
        inputField.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault(); 
                let code = inputField.value.trim();
                if (!code) return; 

                code = code.toUpperCase();

                // æª¢æ ¸
                if (!/^[A-Z0-9]+$/.test(code)) {
                    triggerError("æ ¼å¼éŒ¯èª¤ï¼", `éæ³•ç¬¦è™Ÿ (åƒ…é™è‹±æ•¸)`);
                    inputField.value = ''; return;
                }
                if (code.length > 16) {
                    triggerError("ç·¨ç¢¼éé•·ï¼", `è¼¸å…¥ ${code.length} ç¢¼ (ä¸Šé™16)`);
                    inputField.value = ''; return;
                }
                if (logs.some(log => log.code === code)) {
                    triggerError("é‡è¤‡æƒæï¼", `ç·¨ç¢¼: ${code} å·²å­˜åœ¨`);
                    inputField.value = ''; return;
                }

                addLog(code);
                inputField.value = ''; 
            }
        });

        document.addEventListener('click', (e) => { 
            if (e.target.classList.contains('btn-del-single')) return;
            if (document.visibilityState === 'visible' && errorOverlay.style.display !== 'flex') inputField.focus(); 
        });
        
        inputField.addEventListener('blur', () => {
            if(errorOverlay.style.display !== 'flex') setTimeout(() => inputField.focus(), 100);
        });

        // ==========================================
        // æ ¸å¿ƒï¼šè­¦å ±è§¸ç™¼ (ä¿®å¾©é †åº)
        // ==========================================
        function triggerError(title, detail) {
            // 1. æœ€å„ªå…ˆï¼šå…ˆé¡¯ç¤ºè¦–è¦ºè­¦å ± (é¿å…éŸ³æ•ˆç•¶æ©Ÿå°è‡´ç•«é¢æ²’åæ‡‰)
            if(errorOverlay) errorOverlay.style.display = 'flex';
            if(errorMsg) errorMsg.textContent = title;
            if(errorDetail) errorDetail.textContent = detail || "";
            
            // 2. å¢åŠ èƒŒæ™¯é–ƒçˆæ•ˆæœ
            document.body.classList.add('body-error');

            // 3. å˜—è©¦æ’­æ”¾è²éŸ³ (åŒ…åœ¨ try-catch ä¸­)
            try {
                playErrorSound();
            } catch(e) {
                console.error("éŸ³æ•ˆæ’­æ”¾å¤±æ•— (ä¸å½±éŸ¿è­¦å ±é¡¯ç¤º)", e);
            }
            
            inputField.blur();
        }

        function dismissError() {
            if(errorOverlay) errorOverlay.style.display = 'none';
            document.body.classList.remove('body-error'); // ç§»é™¤é–ƒçˆ
            inputField.value = ''; 
            inputField.focus();    
        }

        document.addEventListener('keydown', function(e){
            if(e.key === 'Enter' && errorOverlay.style.display === 'flex') {
                e.preventDefault(); dismissError();
            }
        });

        function playErrorSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'square'; oscillator.frequency.value = 120; 
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
            oscillator.start();
            const now = audioCtx.currentTime;
            gainNode.gain.setValueAtTime(1, now);
            gainNode.gain.setValueAtTime(0, now + 0.1);
            gainNode.gain.setValueAtTime(1, now + 0.2);
            gainNode.gain.setValueAtTime(0, now + 0.3);
            gainNode.gain.setValueAtTime(1, now + 0.4);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
            oscillator.stop(now + 0.9);
        }

        // ==========================================
        // å…¶ä»–åŠŸèƒ½
        // ==========================================
        function checkAutoArchive() {
            const today = getTodayStr();
            if(dateStatus) dateStatus.textContent = `ä½œæ¥­æ—¥æœŸï¼š${today}`;

            if (lastActiveDate !== today) {
                if (logs.length > 0) {
                    downloadTxt(lastActiveDate);
                    logs = []; saveToStorage(); renderScreenTable();
                    alert(`åµæ¸¬åˆ°æ›æ—¥ï¼å·²è‡ªå‹•å‚™ä»½ ${lastActiveDate} çš„ç´€éŒ„ä¸¦æ¸…ç©ºã€‚`);
                }
                lastActiveDate = today;
                try { localStorage.setItem('lastActiveDate', lastActiveDate); } catch(e){}
            }
        }

        function addLog(code) {
            const now = new Date();
            const dateStr = getTodayStr();
            const timeStr = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0') + ":" + String(now.getSeconds()).padStart(2, '0');
            logs.unshift({ date: dateStr, time: timeStr, code: code });
            saveToStorage(); renderScreenTable();
        }

        function deleteLog(index) {
            if (confirm(`ç¢ºå®šåˆªé™¤ ${logs[index].code} ?`)) {
                logs.splice(index, 1); saveToStorage(); renderScreenTable(); inputField.focus();
            } else { inputField.focus(); }
        }

        function renderScreenTable() {
            screenTableBody.innerHTML = ''; 
            logs.forEach((log, index) => {
                const row = screenTableBody.insertRow();
                row.insertCell(0).textContent = log.date;
                let timeCell = row.insertCell(1); timeCell.textContent = log.time; timeCell.className = "col-time-screen";
                let codeCell = row.insertCell(2); codeCell.textContent = log.code; codeCell.style.fontFamily = "monospace"; codeCell.style.fontWeight = "bold";
                let actionCell = row.insertCell(3);
                let delBtn = document.createElement('button'); delBtn.textContent = 'åˆªé™¤'; delBtn.className = 'btn-del-single';
                delBtn.onclick = function() { deleteLog(index); }; actionCell.appendChild(delBtn);
            });
            countDisplay.textContent = `ç›®å‰ç­†æ•¸ï¼š${logs.length}`;
        }

        function downloadTxt(targetDate) {
            if (logs.length === 0) { if(!targetDate) alert("ç„¡è³‡æ–™"); return; }
            const dateToUse = targetDate || getTodayStr();
            let content = "æ—¥æœŸ\t\tæ™‚é–“\t\tç·¨ç¢¼\n--------------------------------------\n";
            logs.forEach(log => { content += `${log.date}\t${log.time}\t${log.code}\n`; });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([content], { type: 'text/plain' }));
            link.download = `Log_${dateToUse}.txt`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function clearLogs() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨ï¼Ÿ')) {
                logs = []; saveToStorage(); renderScreenTable(); inputField.focus();
            }
        }

        function saveToStorage() {
            try { localStorage.setItem('scanLogs', JSON.stringify(logs)); localStorage.setItem('lastActiveDate', lastActiveDate); } catch (e) {}
        }

        function printReceipt(mode) {
            if (logs.length === 0) { alert("ç„¡è³‡æ–™"); return; }
            printContainer.innerHTML = '';
            const now = new Date();
            const dateStr = now.getFullYear() + "/" + (now.getMonth()+1) + "/" + now.getDate();
            const totalItems = logs.length;

            if (mode === 'Thermal') {
                document.body.classList.add('thermal-mode');
                const ITEMS_PER_PAGE = 12;
                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                for (let i = 0; i < totalPages; i++) {
                    const pageNum = i + 1; const isLastPage = (pageNum === totalPages);
                    const pageData = logs.slice(i * ITEMS_PER_PAGE, (i + 1) * ITEMS_PER_PAGE);
                    const pageDiv = document.createElement('div'); pageDiv.className = 'print-page';
                    
                    let tableHTML = `<table><thead><tr><th class="col-date">æ—¥æœŸ</th><th>è²¨è™Ÿ / ç·¨ç¢¼</th><th class="print-only sign-col" style="width: 50px;">ç°½æ”¶</th></tr></thead><tbody>`;
                    pageData.forEach(log => { tableHTML += `<tr><td class="col-date">${log.date}</td><td style="font-family: monospace; font-weight: bold;">${log.code}</td><td class="sign-col"></td></tr>`; });
                    tableHTML += `</tbody></table>`;
                    
                    let summaryHTML = isLastPage ? `<div class="final-summary"><div class="total-line">ç¸½è¨ˆï¼š${totalItems} ä»¶</div><div class="signer-section">ç°½æ”¶äººï¼š____________________</div></div>` : '';
                    pageDiv.innerHTML = `<div class="print-header"><h1>ç‰©æµç°½æ”¶å–®</h1><div class="print-info">ç°½æ”¶æ—¥æœŸï¼š${dateStr}</div></div>${tableHTML}${summaryHTML}<div class="page-footer">ç¬¬ ${pageNum} / ${totalPages} é </div>`;
                    printContainer.appendChild(pageDiv);
                }
                const styleId = 'thermal-page-style';
                let oldStyle = document.getElementById(styleId); if (oldStyle) oldStyle.remove();
                const css = '@page { size: 100mm 150mm; margin: 0; }';
                const style = document.createElement('style'); style.id = styleId; style.type = 'text/css'; style.appendChild(document.createTextNode(css)); document.head.appendChild(style);
            } else {
                document.body.classList.remove('thermal-mode');
                let html = `<div class="print-page"><div class="print-header" style="text-align:center; border-bottom:2px solid #000; margin-bottom:20px;"><h1>ç‰©æµç°½æ”¶å–® (A4å½™ç¸½)</h1><div class="print-info" style="text-align:right;">ç°½æ”¶æ—¥æœŸï¼š${dateStr}</div></div><table><thead><tr><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>è²¨è™Ÿ / ç·¨ç¢¼</th><th>ç°½æ”¶</th></tr></thead><tbody>`;
                logs.forEach(log => { html += `<tr><td>${log.date}</td><td>${log.time}</td><td style="font-family: monospace; font-weight: bold;">${log.code}</td><td></td></tr>`; });
                html += `</tbody></table><div class="signer-section" style="text-align:right; font-size:14pt; font-weight:bold; margin-top:30px; padding-top:10px; border-top:2px solid #000;">ç¸½è¨ˆï¼š${totalItems} ä»¶ &nbsp;&nbsp;&nbsp;&nbsp; ç°½æ”¶äººï¼š____________________</div></div>`;
                printContainer.innerHTML = html;
            }
            setTimeout(() => { window.print(); }, 100);
        }
    </script>
</body>
</html>
